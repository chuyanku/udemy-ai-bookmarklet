  <script>
    // --- DOM Elements ---
    const productForm = document.getElementById("product-form");
    const productListBody = document.getElementById("product-list-body");
    const toast = document.getElementById("toast");
    const toastMessage = toast.querySelector('.toast-message');
    const countdownTimerSpan = document.getElementById('countdown-timer');
    const progressBar = toast.querySelector('.toast-progress-bar');
    const fillSampleButton = document.getElementById('fill-sample-button');
    const resetFormButton = document.getElementById('reset-form-button');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const resetProductListButton = document.getElementById('reset-product-list-button');
    const bodyElement = document.body;

    // --- State Variables ---
    let registeredProducts = [];
    let toastTimeout;
    let countdownInterval;
    const localStorageThemeKey = 'productFormTheme';

    // --- Sample Data ---
    const sampleProducts = [
        { name: 'クールマックス リラックスTシャツ', price: 3480, category: 'tshirt', description: '吸水速乾性に優れたクールマックス素材。\nゆったりフィットで日常からアクティビティまで。', stock: 75, condition: 'new', colors: ['white', 'black', 'navy'] },
        { name: 'リネンブレンド ワイドパンツ', price: 5980, category: 'pants', description: '清涼感のあるリネン混素材。\nトレンド感のあるワイドシルエット。ウエストゴムで快適。', stock: 40, condition: 'new', colors: ['beige', 'black', 'green'] },
        { name: 'UVカット カーディガン', price: 2980, category: 'knit', description: '紫外線対策に便利な薄手カーディガン。\n冷房対策にも。持ち運びしやすい。', stock: 120, condition: 'new', colors: ['white', 'gray', 'navy', 'pink'] },
        { name: 'キャンバス トートバッグ', price: 4500, category: 'bag', description: '丈夫なキャンバス生地の大容量トート。\n内ポケット付き。通勤・通学にも。', stock: 60, condition: 'new', colors: ['white', 'black', 'beige'] },
        { name: '【中古】ヴィンテージ デニムジャケット', price: 7800, category: 'outerwear', description: '雰囲気のある色落ちが魅力のヴィンテージGジャン。\n一点物。状態は良好です。', stock: 1, condition: 'used_good', colors: ['blue'] }
    ];

    // --- Theme Handling ---
    function applyTheme(theme) { if (theme === 'dark') { bodyElement.classList.add('dark-theme'); } else { bodyElement.classList.remove('dark-theme'); } }
    function toggleTheme() { const currentTheme = bodyElement.classList.contains('dark-theme') ? 'dark' : 'light'; const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(newTheme); localStorage.setItem(localStorageThemeKey, newTheme); }
    const savedTheme = localStorage.getItem(localStorageThemeKey); applyTheme(savedTheme || 'light');

    // --- Render Product Table Function ---
    function renderProductTable() {
        productListBody.innerHTML = '';
        if (registeredProducts.length === 0) {
            const emptyRow = document.createElement('tr'); emptyRow.classList.add('empty-message-row');
            const emptyCell = document.createElement('td'); emptyCell.setAttribute('colspan', 5);
            emptyCell.textContent = '商品が未登録です'; emptyRow.appendChild(emptyCell); productListBody.appendChild(emptyRow);
        } else {
            registeredProducts.forEach((product) => {
                const row = document.createElement('tr');
                const cellIndex = document.createElement('td'); cellIndex.textContent = product.id; row.appendChild(cellIndex);
                const cellName = document.createElement('td'); cellName.textContent = product.name; cellName.setAttribute('data-label', '商品名'); row.appendChild(cellName);
                const cellPrice = document.createElement('td'); cellPrice.textContent = `¥${Number(product.price).toLocaleString()}`; cellPrice.setAttribute('data-label', '金額'); row.appendChild(cellPrice);
                const cellCategory = document.createElement('td'); const categorySelect = document.getElementById('category'); const selectedOption = categorySelect.querySelector(`option[value="${product.category}"]`); cellCategory.textContent = selectedOption ? selectedOption.textContent : product.category; cellCategory.setAttribute('data-label', 'カテゴリ'); row.appendChild(cellCategory);
                const cellDesc = document.createElement('td'); const shortDesc = product.description && product.description.length > 20 ? product.description.substring(0, 20) + "…" : (product.description || ''); cellDesc.textContent = shortDesc; cellDesc.setAttribute('data-label', '商品詳細'); row.appendChild(cellDesc);
                productListBody.appendChild(row);
            });
        }
    }

    // --- Reset Product List Function ---
    function resetProductList() {
        console.log("Resetting product list...");
        registeredProducts = []; renderProductTable();
        showToast("登録商品リストをリセットしました。", "success");
    }

    // --- Form Functions ---
    function fillSampleData() {
        resetFormVisuals(); hideToast();
        if (!sampleProducts || sampleProducts.length === 0) { console.error("Sample product data is missing."); showToast("サンプルデータの読み込みに失敗しました。", "error"); return; }
        const sampleIndex = Math.floor(Math.random() * sampleProducts.length); const sample = sampleProducts[sampleIndex];
        if (!sample) { console.error("Failed to get sample product."); showToast("サンプルデータの取得に失敗しました。", "error"); return; }
        try {
            document.getElementById('product-name').value = sample.name || ''; document.getElementById('price').value = sample.price || 0; document.getElementById('category').value = sample.category || '';
            document.getElementById('description').value = sample.description || ''; document.getElementById('stock').value = sample.stock || 0;
            const today = new Date(); const releaseDate = new Date(today); releaseDate.setDate(today.getDate() + 3);
            const year = releaseDate.getFullYear(); const month = String(releaseDate.getMonth() + 1).padStart(2, '0'); const day = String(releaseDate.getDate()).padStart(2, '0');
            document.getElementById('release-date').value = `${year}-${month}-${day}`;
            const conditionValue = sample.condition || 'new'; const conditionRadio = document.querySelector(`input[name="condition"][value="${conditionValue}"]`);
            if (conditionRadio) conditionRadio.checked = true; else document.querySelector('input[name="condition"][value="new"]').checked = true;
            const colorCheckboxes = document.querySelectorAll('input[name="colors"]'); colorCheckboxes.forEach(checkbox => checkbox.checked = false);
            const colorsToSelect = sample.colors || []; colorsToSelect.forEach(colorValue => { const colorCheckbox = document.querySelector(`input[name="colors"][value="${colorValue}"]`); if (colorCheckbox) colorCheckbox.checked = true; });
        } catch (error) { console.error("Error filling sample data:", error); showToast("サンプルデータの入力中にエラーが発生しました。", "error"); }
    }
    function resetForm() {
        productForm.reset(); resetFormVisuals(); hideToast();
        const defaultRadio = productForm.querySelector('input[name="condition"][value="new"]'); if(defaultRadio) defaultRadio.checked = true;
        const categorySelect = document.getElementById('category'); if(categorySelect) categorySelect.value = "";
    }
    function resetFormVisuals() {
        const fields = productForm.querySelectorAll('.form-control'); fields.forEach(field => field.style.borderColor = '');
        if(progressBar) { progressBar.style.transition = 'none'; progressBar.style.transform = 'scaleX(1)'; }
    }

    // --- Event Listeners ---
    if (themeToggleButton) { themeToggleButton.addEventListener('click', toggleTheme); }
    if (fillSampleButton) { fillSampleButton.addEventListener('click', fillSampleData); }
    if (resetFormButton) { resetFormButton.addEventListener('click', resetForm); }
    if (resetProductListButton) { resetProductListButton.addEventListener('click', resetProductList); }

    productForm.addEventListener("submit", function(e) {
      e.preventDefault(); let isValid = true;
      const requiredFields = productForm.querySelectorAll('[required]');
      requiredFields.forEach(field => { field.style.borderColor = ''; if (!field.value.trim() || (field.type === 'select-one' && field.value === "")) { isValid = false; field.style.borderColor = 'var(--error-color)'; } });
      if (!isValid) { showToast("必須項目を入力または選択してください。", "error"); const firstInvalidField = productForm.querySelector('[style*="border-color"]'); if (firstInvalidField) { setTimeout(() => firstInvalidField.focus({ preventScroll: true }), 50); } return; }

      const newProduct = { id: registeredProducts.length + 1, name: document.getElementById('product-name').value, price: document.getElementById('price').value, category: document.getElementById('category').value, description: document.getElementById('description').value, };
      registeredProducts.push(newProduct); renderProductTable();

      clearTimeout(toastTimeout); clearInterval(countdownInterval);
      showToast("商品情報を登録しました (サンプル)", "success");
      // Countdown is started within showToast now for success message
      // toastTimeout = setTimeout(() => { resetForm(); }, 5000); // Reset timer is set within showToast
    });

    // --- Countdown Function ---
    function startCountdown(seconds) {
        // Clear any existing interval before starting a new one
        clearInterval(countdownInterval);

        let remainingSeconds = seconds;
        if(countdownTimerSpan) {
             // Initial display, ensure integer
             countdownTimerSpan.textContent = Math.floor(remainingSeconds);
        }
        if(progressBar) {
             progressBar.style.transition = 'none';
             progressBar.style.transform = 'scaleX(1)';
             progressBar.offsetHeight; // Reflow
        }
        // Ensure shrinking class is added after display
        setTimeout(() => {
             if (toast.classList.contains('show')) {
                 toast.classList.add('shrinking');
             }
        }, 0);

        countdownInterval = setInterval(() => {
            remainingSeconds -= 1; // Decrement by 1
            if(countdownTimerSpan) {
                // Ensure integer and >= 0 for display
                countdownTimerSpan.textContent = Math.max(0, Math.floor(remainingSeconds));
            }
            if (remainingSeconds <= 0) {
                clearInterval(countdownInterval); // Stop the interval
            }
        }, 1000); // Run every 1000ms (1 second)
    }

    // --- Toast Functions ---
    function showToast(message, type = "success") {
        clearTimeout(toastTimeout); clearInterval(countdownInterval); // Clear previous timers

        toastMessage.textContent = message;
        toast.classList.remove('error', 'shrinking');
        const subMessage = toast.querySelector('.toast-sub-message');
        const mainSuccessMessage = "商品情報を登録しました (サンプル)";
        const resetListMessage = "登録商品リストをリセットしました。";

        // Reset progress bar before showing
         if(progressBar) {
             progressBar.style.transition = 'none';
             progressBar.style.transform = 'scaleX(1)';
             progressBar.style.display = 'none'; // Hide initially
         }
        // Reset sub-message visibility
        if(subMessage) {
            subMessage.style.display = 'none';
        }

        if (type === "error") {
            toast.classList.add('error');
        } else { // Success messages
            const icon = toast.querySelector('.toast-icon svg');
            if (icon) { icon.style.display = 'none'; icon.offsetHeight; icon.style.display = ''; }

            if (message === mainSuccessMessage) {
                // Show sub-message and progress bar only for main success
                if(subMessage) subMessage.style.display = 'block';
                if(progressBar) progressBar.style.display = 'block';
                startCountdown(5); // Start countdown
                 // Set timer to reset the form
                 toastTimeout = setTimeout(resetForm, 5000);
            } else {
                 // For other success messages (like list reset), auto-hide after 3s
                 toastTimeout = setTimeout(hideToast, 3000);
            }
        }
        toast.classList.add("show"); // Make toast visible
    }

    function hideToast() {
        clearTimeout(toastTimeout); clearInterval(countdownInterval);
        toast.classList.remove("show", "shrinking");
        if(progressBar) { progressBar.style.transition = 'none'; progressBar.style.transform = 'scaleX(1)'; }
    }

    // --- Reset Error Style ---
     productForm.addEventListener('input', function(e) { if (e.target.style.borderColor) { e.target.style.borderColor = ''; } });
     productForm.addEventListener('change', function(e) { if (e.target.tagName === 'SELECT' && e.target.style.borderColor) { e.target.style.borderColor = ''; } });

    // --- Initial Table Render ---
    document.addEventListener('DOMContentLoaded', renderProductTable);

  </script>
</body>
</html>
